#author: hitech
#date: 2014-05-18
---
- hosts: all
  gather_facts: False
  vars:
      timestamp: '{{picklebot["variables"]["time_stamp"]|dateFormat("%d %b %Y %H:%M:%S","%Y\\/%m\\/%d %H")}}'
      valid_urls:
          - public
          - webpickle
          - jar

  
  tasks:
  - name: get the base url of the request
    shell: sed -n -e  '/{{timestamp}}/,$p' /var/log/nginx/error.log | awk -F \" '{print $4}' | awk '{print $2}' | awk -F / '{print $2}'
    register: req_urls
    when: picklebot["variables"]["state"] == "failed"

  - name: check if errored roots are valid ones
    picklebot: resolve
    when: picklebot["variables"]["state"] == "succeeded"  or valid_urls|intersect(req_urls.stdout_lines)|count == 0 


